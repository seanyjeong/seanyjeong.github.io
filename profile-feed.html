<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ì‚¬ìš©ì í”„ë¡œí•„</title>
  <link href="https://cdn.jsdelivr.net/npm/water.css@2/out/light.min.css" rel="stylesheet">
  <link rel="stylesheet" href="css/reset.css">
  <link rel="stylesheet" href="css/feed.css">
  <style>
.bottom-nav {
  position: fixed;
  bottom: 0;
  left: 0;
  width: 100%;
  background: #fff;
  display: flex;
  justify-content: space-around; /* âœ… ë²„íŠ¼ ê· ë“±í•˜ê²Œ ë°°ì¹˜ */
  align-items: center;
  padding: 6px 0;
  border-top: 1px solid #ccc;


  z-index: 999;
}
    
    .bottom-nav button {
      background: none;
      border: none;
      font-size: 1.2rem;  /* âœ… ì ë‹¹í•œ í¬ê¸°ë¡œ ì¤„ì´ê¸° */
      padding: 4px;
      flex: 1;
      text-align: center;
    }
    .bottom-nav .plus-btn {
      font-size: 1.6rem;       /* ê°€ìš´ë°ë§Œ ì‚´ì§ ê°•ì¡° */
      transform: translateY(-4px); /* ì•½ê°„ ìœ„ë¡œ ë„ìš°ë©´ ê°ì„± ğŸ˜ */
    }
    .profile-actions {
    display: flex;
    justify-content: center;
    gap: 16px;
    margin-top: 10px;
    font-size: 0.95rem;
    color: #555;
  }

  .profile-actions span {
    cursor: pointer;
    text-decoration: underline dotted;
    font-weight: 500;
  }

  .profile-actions span:hover {
    color: #222;
  }
    
    </style>
</head>
<body>
  <section style="padding-bottom: 80px;">
    <div class="profile-header" style="text-align: center; margin-bottom: 20px;">
      <img id="profile-image" src="https://placehold.co/100x100" alt="í”„ë¡œí•„ ì´ë¯¸ì§€" style="width: 100px; height: 100px; border-radius: 50%;">
      <h2 id="profile-name">ì‚¬ìš©ìì´ë¦„</h2>
      <div class="profile-actions">
        <span onclick="location.href='profile.html'">âœï¸ í”„ë¡œí•„ ìˆ˜ì •</span>
        <span onclick="location.href='goal.html'">ğŸ“Œ ëª©í‘œ ì„¤ì •</span>
        <span onclick="logout()">ğŸšª ë¡œê·¸ì•„ì›ƒ</span>
      </div>
      
      
    <!-- ì†Œê°œê¸€ í‘œì‹œ -->
<p id="profile-intro" style="margin-top: 10px; font-size: 0.9rem; color: #555;"></p>

<!-- í¸ì§‘ ë²„íŠ¼ (ë‚´ ê³„ì •ì¼ ê²½ìš°ì—ë§Œ ë³´ì—¬ì¤Œ) -->
<span id="edit-intro-btn" 
      style="display: none; font-size: 0.85rem; color: #888; text-decoration: underline dotted; cursor: pointer;">
  âœï¸ ì†Œê°œê¸€ í¸ì§‘
</span>
<!-- ì†Œê°œê¸€ ì•„ë˜ì— ì¶”ê°€ -->
<div id="goal-summary" style="margin-top: 12px; font-size: 0.9rem; color: #333;">
  <strong>ğŸ¯ ë‚˜ì˜ ëª©í‘œ ê¸°ë¡</strong>
  <ul id="goal-list" style="padding-left: 16px; margin-top: 6px; list-style-position: inside;"></ul>

</div>





<!-- textarea + ì €ì¥ ë²„íŠ¼ (ì´ˆê¸°ì—ëŠ” ìˆ¨ê¹€) -->
<div id="intro-edit-area" style="display: none; margin-top: 8px;">
  <textarea id="intro-textarea" rows="2" style="width: 90%; max-width: 400px;"></textarea><br>
  <button onclick="saveIntro()">ì €ì¥</button>
</div>


    <h3 style="text-align: center;">ğŸ“¸ í”¼ë“œ</h3>
    <div id="feeds" class="grid-feed-wrapper"></div>
  </section>

  <div class="bottom-nav">
    <button onclick="location.href='index.html'">
      <!-- home.svg -->
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-house"><path d="M15 21v-8a1 1 0 0 0-1-1h-4a1 1 0 0 0-1 1v8"/><path d="M3 10a2 2 0 0 1 .709-1.528l7-5.999a2 2 0 0 1 2.582 0l7 5.999A2 2 0 0 1 21 10v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/></svg>
    </button>

    <button onclick="location.href='upload.html'" title="ì—…ë¡œë“œ">
      <!-- plus.svg -->
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-plus"><path d="M5 12h14"/><path d="M12 5v14"/></svg>
    </button>
    <button onclick="location.href='record-chart.html'" title="ê¸°ë¡ì°¨íŠ¸">
      <!-- video.svg -->
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-chart-spline"><path d="M3 3v16a2 2 0 0 0 2 2h16"/><path d="M7 16c.5-2 1.5-7 4-7 2 0 2 3 4 3 2.5 0 4.5-5 5-7"/></svg>
    
      <button onclick="location.href='profile-feed.html'">
      <img id="nav-profile-img" src="https://placehold.co/32x32" alt="ë‚´ í”„ë¡œí•„" style="width: 32px; height: 32px; border-radius: 50%;" />
    </button>
    
  </div>

  <script>
    const api = 'https://supermax.kr/feed';
    const params = new URLSearchParams(window.location.search);
    const userId = params.get("userId") || localStorage.getItem("user_id");
    const myUserId = localStorage.getItem("user_id");
    const token = localStorage.getItem("token");

    if (!userId || !token) {
      alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
      location.href = "login.html";
    }

    async function loadUserProfile() {
  try {
    const res = await fetch(`${api}/user-info`, {
      method: 'POST',
      headers: {
        'Authorization': 'Bearer ' + token,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ user_id: userId })
    });

    if (!res.ok) {
      const text = await res.text();
      throw new Error("ì„œë²„ ì‘ë‹µ ì˜¤ë¥˜: " + text);
    }

    const data = await res.json();

    // ì´ë¦„, ì†Œê°œê¸€, í”„ë¡œí•„ ì´ë¯¸ì§€ í‘œì‹œ
    document.getElementById("profile-name").innerText = data.name || "ì‚¬ìš©ì";
    document.getElementById("profile-intro").innerText = data.intro || '';
    document.getElementById("profile-image").src = data.profile_image || "https://placehold.co/100x100";

    // ğŸ”¥ ë¡œê·¸ì¸í•œ ì‚¬ìš©ì ë³¸ì¸ì¼ ê²½ìš°ì—ë§Œ ë²„íŠ¼ë“¤ ë³´ì—¬ì¤Œ
    if (userId === myUserId) {
      // ì†Œê°œê¸€ í¸ì§‘ ë²„íŠ¼
      document.getElementById("edit-intro-btn").style.display = "inline";
      document.getElementById("edit-intro-btn").onclick = () => {
        document.getElementById("intro-edit-area").style.display = "block";
        document.getElementById("intro-textarea").value = data.intro || '';
      };

      // profile-actionsì— ë²„íŠ¼ ë™ì ìœ¼ë¡œ ì‚½ì…
      document.querySelector(".profile-actions").innerHTML = `
        <span onclick="location.href='profile.html'">âœï¸ í”„ë¡œí•„ ìˆ˜ì •</span>
        <span onclick="location.href='goal.html'">ğŸ“Œ ëª©í‘œ ì„¤ì •</span>
        <span onclick="logout()">ğŸšª ë¡œê·¸ì•„ì›ƒ</span>
      `;
    } else {
      // ë‚´ ê³„ì •ì´ ì•„ë‹ ê²½ìš° ë²„íŠ¼ ìˆ¨ê¹€
      document.querySelector(".profile-actions").style.display = "none";
    }

  } catch (e) {
    console.error("âŒ ìœ ì € ì •ë³´ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨", e);
  }
}

async function saveIntro() {
  const intro = document.getElementById("intro-textarea").value;
  const token = localStorage.getItem("token");

  const res = await fetch("https://supermax.kr/feed/update-profile", {
    method: "POST",
    headers: {
      "Authorization": "Bearer " + token,
      "Content-Type": "application/json"
    },
    body: JSON.stringify({ intro })
  });

  if (res.ok) {
    document.getElementById("profile-intro").innerText = intro;
    document.getElementById("intro-edit-area").style.display = "none";
    alert("ì†Œê°œê¸€ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!");
  } else {
    alert("ì†Œê°œê¸€ ì €ì¥ ì‹¤íŒ¨");
  }
}



async function loadMyProfileImageForNav() {
  const token = localStorage.getItem("token");
  const userId = localStorage.getItem("user_id");

  if (!token || !userId) return;

  try {
    const res = await fetch("https://supermax.kr/feed/user-info", {
      method: "POST",
      headers: {
        "Authorization": "Bearer " + token,
        "Content-Type": "application/json"
      },
      body: JSON.stringify({ user_id: userId })
    });

    if (!res.ok) {
      const html = await res.text();
      console.warn("âŒ ì„œë²„ ì‘ë‹µ HTML:", html);
      return;
    }

    const data = await res.json();
    document.getElementById("nav-profile-img").src = data.profile_image || "https://placehold.co/32x32";
  } catch (e) {
    console.warn("ğŸ‘¤ ë‚´ í”„ë¡œí•„ ì´ë¯¸ì§€ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨", e);
  }
}
async function loadUserGoals() {
  const res = await fetch(`${api}/my-goals`, {
    headers: { 'Authorization': 'Bearer ' + token }
  });

  if (!res.ok) return;

  const data = await res.json();
  const list = document.getElementById("goal-list");

  if (data.length === 0) {
    list.innerHTML = '<li style="color: #888;">ì„¤ì •ëœ ëª©í‘œê°€ ì—†ìŠµë‹ˆë‹¤.</li>';
    return;
  }

  list.innerHTML = data.map(goal => {
    const unit = getUnit(goal.event);
    return `<li>${goal.event}: ${goal.goal_record}${unit}</li>`;
  }).join('');
}

// ë‹¨ìœ„ ì²˜ë¦¬
function getUnit(event) {
  if (event.includes('ë©€ë¦¬') || event.includes('ì¢Œì „êµ´')) return 'cm';
  if (event.includes('ë©”ë””ì‹ ')) return 'm';
  if (event.includes('ë°°ê·¼')) return 'kg';
  if (event.includes('ë‹¬ë¦¬ê¸°')) return 'ì´ˆ';
  if (event.includes('ìœ—ëª¸')) return 'íšŒ';
  return '';
}

async function loadUserGoals() {
  const list = document.getElementById("goal-list");

  try {
    let res;

    if (userId === myUserId) {
      // âœ… ë‚´ ê³„ì •ì¼ ë•Œ
      res = await fetch(`${api}/my-goals`, {
        headers: { 'Authorization': 'Bearer ' + token }
      });
    } else {
      // âœ… ë‹¤ë¥¸ ì‚¬ëŒ ê³„ì •ì¼ ë•Œ
      res = await fetch(`${api}/user-goals/${userId}`);
    }

    if (!res.ok) return;

    const data = await res.json();

    if (data.length === 0) {
      list.innerHTML = '<li style="color: #888;">ì„¤ì •ëœ ëª©í‘œê°€ ì—†ìŠµë‹ˆë‹¤.</li>';
      return;
    }

    list.innerHTML = data.map(goal => {
      const unit = getUnit(goal.event);
      return `<li>${goal.event}: ${goal.goal_record}${unit}</li>`;
    }).join('');
  } catch (e) {
    console.error("ğŸ¯ ëª©í‘œ ê¸°ë¡ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨", e);
    list.innerHTML = '<li style="color: #888;">ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨</li>';
  }
}

async function loadUserMedals() {
  try {
    const res = await fetch(`${api}/user-achievements/${userId}`);
    if (!res.ok) return;

    const medals = await res.json();
    const medalCount = medals.length;
    const medalIcons = 'ğŸ…'.repeat(medalCount);

    const nameEl = document.getElementById("profile-name");
    nameEl.innerHTML += `<span style="font-size: 1rem; margin-left: 6px;">${medalIcons}</span>`;
  } catch (e) {
    console.error("ğŸ… ë©”ë‹¬ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨", e);
  }
}




    async function loadFeeds() {
      try {
        const res = await fetch(`${api}/user-feeds/${userId}`, {
          headers: { 'Authorization': 'Bearer ' + token }
        });
        const feeds = await res.json();

        const container = document.getElementById("feeds");
        container.innerHTML = feeds.map(feed => {
  let media = '';
  try {
    const mediaArray = JSON.parse(feed.media_url);
    if (Array.isArray(mediaArray) && mediaArray.length > 0) {
      const url = mediaArray[0];
      media = url.includes('.mp4')
        ? `<video src="${url}" muted preload="metadata"></video>`
        : `<img src="${url}" alt="í”¼ë“œ ì¸ë„¤ì¼">`;
    } else {
      // âœ… ê¸°ë¡ë§Œ ìˆëŠ” ê²½ìš° â†’ ê¸°ë¡ ì¸ë„¤ì¼ ë§Œë“¤ì–´ì£¼ê¸°
      media = `

            ğŸ… ${feed.event || 'ì¢…ëª© ì—†ìŒ'}<br/>
            ${feed.record || 'ê¸°ë¡ ì—†ìŒ'}
          </div>
        </div>
      `;
    }
  } catch {}

  return `<div class="thumbnail" onclick="location.href='feed-detail.html?feedId=${feed.id}'">${media}</div>`;
}).join('');

      } catch (e) {
        console.error("í”¼ë“œ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨", e);
      }
    }

    function logout() {
      localStorage.removeItem('token');
      localStorage.removeItem('user_id');
      location.href = 'login.html';
    }

    document.addEventListener("DOMContentLoaded", async () => {
  const token = localStorage.getItem("token");
  const userId = new URLSearchParams(location.search).get("userId") || localStorage.getItem("user_id");

  // âœ… ì—¬ê¸°ì— ë”± ë„£ì–´ì¤˜!
  if (!token || !userId) {
    localStorage.setItem("redirect_after_login", location.href);
    alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
    location.href = "login.html";
    return;
  }
  await loadMyProfileImageForNav();  // âœ… ì´ê²Œ í•µì‹¬!
  await loadUserProfile(); // â† ë¡œê·¸ì¸ëœ ìƒíƒœë©´ í”„ë¡œí•„ ì •ë³´ ë¶ˆëŸ¬ì˜¤ê¸°
  await loadFeeds();       // â† ìœ ì € í”¼ë“œ ì¶œë ¥
  await loadUserGoals();
  await loadUserMedals(); // ğŸ… ëˆ„ì  ë©”ë‹¬ í‘œì‹œ ì¶”ê°€

});

  </script>
</body>
</html>

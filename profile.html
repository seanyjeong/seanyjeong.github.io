<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ë‚´ ì •ë³´ ìˆ˜ì • - MaxFeed</title>
  <link href="https://cdn.jsdelivr.net/npm/water.css@2/out/light.min.css" rel="stylesheet">
</head>
<body>

<h2>ë‚´ ì •ë³´ ìˆ˜ì •</h2>

<!-- í”„ë¡œí•„ ì´ë¯¸ì§€ -->
<img id="profile_img" src="https://placehold.co/100x100" alt="í”„ë¡œí•„ ì´ë¯¸ì§€" style="border-radius: 50%;">
<label>í”„ë¡œí•„ ì´ë¯¸ì§€</label>
<input type="file" id="profile_image">

<!-- ì „í™”ë²ˆí˜¸ ìˆ˜ì • -->
<label>ì „í™”ë²ˆí˜¸</label>
<input type="text" id="phone" placeholder="ì „í™”ë²ˆí˜¸">

<!-- ìƒë…„ì›”ì¼ ìˆ˜ì • -->
<label>ìƒë…„ì›”ì¼</label>
<input type="date" id="birth_date">

<!-- ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ -->
<label>í˜„ì¬ ë¹„ë°€ë²ˆí˜¸</label>
<input type="password" id="current_password" placeholder="í˜„ì¬ ë¹„ë°€ë²ˆí˜¸ (ë³€ê²½ ì‹œ ì…ë ¥)">

<label>ìƒˆ ë¹„ë°€ë²ˆí˜¸</label>
<input type="password" id="new_password" placeholder="ìƒˆ ë¹„ë°€ë²ˆí˜¸ (ë³€ê²½í•  ê²½ìš°ë§Œ ì…ë ¥)">

<label>ìƒˆ ë¹„ë°€ë²ˆí˜¸ í™•ì¸</label>
<input type="password" id="confirm_password" placeholder="ìƒˆ ë¹„ë°€ë²ˆí˜¸ í™•ì¸">

<button onclick="updateProfile()">ìˆ˜ì •</button>
<button onclick="location.href='index.html'">ì´ì „</button>

<script>
    const api = 'https://supermax.kr/feed';
    
    // âœ… í˜„ì¬ í”„ë¡œí•„ ë° ì •ë³´ ê°€ì ¸ì˜¤ê¸°
    async function loadProfile() {
        const res = await fetch(`${api}/user-info`, {
            headers: { 'Authorization': 'Bearer ' + localStorage.getItem('token') }
        });
        
        if (!res.ok) {
            alert("ì‚¬ìš©ì ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!");
            return;
        }
    
        const data = await res.json();
        if (data.success) {
            document.getElementById('profile_img').src = data.profile_image || "https://placehold.co/100x100";
            document.getElementById('phone').value = data.phone || ''; // âœ… ì „í™”ë²ˆí˜¸ ìë™ ì…ë ¥
            document.getElementById('birth_date').value = data.birth_date ? data.birth_date.substring(0, 10) : ''; // âœ… ìƒë…„ì›”ì¼ ìë™ ì…ë ¥
        }
    }
    
    // âœ… ë‚´ ì •ë³´ ìˆ˜ì • ìš”ì²­
    async function updateProfile() {
        const formData = new FormData();
        const fileInput = document.getElementById('profile_image');
        const phone = document.getElementById('phone').value;
        const birth_date = document.getElementById('birth_date').value;
        const current_password = document.getElementById('current_password').value;
        const new_password = document.getElementById('new_password').value;
        const confirm_password = document.getElementById('confirm_password').value;
    
        if (fileInput.files.length) formData.append('profile_image', fileInput.files[0]);
        if (phone) formData.append('phone', phone);
        if (birth_date) formData.append('birth_date', birth_date);
        if (current_password) formData.append('current_password', current_password);
        if (new_password) formData.append('new_password', new_password);
        if (confirm_password) formData.append('confirm_password', confirm_password);
    
        if (new_password && new_password !== confirm_password) {
            alert("ìƒˆ ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤!");
            return;
        }
    
        const res = await fetch(`${api}/update-profile`, {
            method: 'POST',
            headers: { 'Authorization': 'Bearer ' + localStorage.getItem('token') },
            body: formData
        });
    
        const data = await res.json();
        if (res.ok) {
            alert('ìˆ˜ì • ì™„ë£Œ!');
            if (data.profile_url) {
                document.getElementById('profile_img').src = data.profile_url;
            }
            location.href = 'index.html';
        } else {
            console.error("ğŸ”¥ ì„œë²„ ì‘ë‹µ ì˜¤ë¥˜:", data);
            alert('ìˆ˜ì • ì‹¤íŒ¨: ' + (data.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
        }
    }
    
    // âœ… í˜ì´ì§€ ë¡œë“œ ì‹œ ê¸°ì¡´ ì •ë³´ ë¶ˆëŸ¬ì˜¤ê¸°
    document.addEventListener("DOMContentLoaded", loadProfile);
    </script>
    

</body>
</html>
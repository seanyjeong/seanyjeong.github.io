<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>stack ìˆ˜ì •</title>
  <link href="https://cdn.jsdelivr.net/npm/water.css@2/out/light.min.css" rel="stylesheet">
  <style>
    .media-preview {
      position: relative;
      display: inline-block;
      margin: 8px 4px;
    }
    .media-preview img,
    .media-preview video {
      max-width: 200px;
      max-height: 200px;
      border-radius: 6px;
    }
    .delete-media-btn {
      position: absolute;
      top: 4px;
      right: 4px;
      background: rgba(0,0,0,0.5);
      color: white;
      border: none;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      cursor: pointer;
    }
    .input-wrapper {
  position: relative;
  border: 1px solid #ccc;
  border-radius: 6px;
}
.input-wrapper:focus-within {
  border-color: #007bff;
  box-shadow: 0 0 0 2px rgba(0,123,255,0.2);
}
.tag-preview {
  position: absolute;
  top: 0;
  left: 0;
  white-space: pre-wrap;
  word-wrap: break-word;
  pointer-events: none;
  padding: 8px;
  font-size: 1rem;
  line-height: 1.4;
  width: 100%;
  height: 100%;
  color: black;
  z-index: 1;
}
.tag-preview .hashtag {
  color: #007bff;
  font-weight: bold;
}
#content {
  position: relative;
  background: transparent;
  color: transparent;
  caret-color: black;
  padding: 8px;
  font-size: 1rem;
  width: 100%;
  border: none;
  resize: none;
  z-index: 2;
}

  </style>
</head>
<body>
  <h2>í”¼ë“œ ìˆ˜ì •</h2>

  <label for="event">ì¢…ëª©</label>
  <select id="event">
    <option value="">-- ì„ íƒí•˜ì„¸ìš” --</option>
    <option value="ì œìë¦¬ë©€ë¦¬ë›°ê¸°">ì œìë¦¬ë©€ë¦¬ë›°ê¸°</option>
    <option value="ë©”ë””ì‹ ë³¼ë˜ì§€ê¸°">ë©”ë””ì‹ ë³¼ë˜ì§€ê¸°</option>
    <option value="ë°°ê·¼ë ¥">ë°°ê·¼ë ¥</option>
    <option value="20mì™•ë³µë‹¬ë¦¬ê¸°">20mì™•ë³µë‹¬ë¦¬ê¸°</option>
    <option value="ìœ—ëª¸ì¼ìœ¼í‚¤ê¸°">ìœ—ëª¸ì¼ìœ¼í‚¤ê¸°</option>
    <option value="ì¢Œì „êµ´">ì¢Œì „êµ´</option>
  </select>

  <label for="record">ê¸°ë¡</label>
  <input type="text" id="record" placeholder="ì˜ˆ: 240">

  <label for="content">ë©”ëª¨</label>
  <div class="input-wrapper" style="height: 100px;">
    <div id="tag-preview" class="tag-preview"></div>
    <textarea id="content" style="height: 100px;"></textarea>
  </div>
  

  <h4>ê¸°ì¡´ ë¯¸ë””ì–´</h4>
  <div id="existing-media"></div>

  <h4>ìƒˆë¡œìš´ ë¯¸ë””ì–´ ì¶”ê°€</h4>
  <input type="file" id="files" multiple>
  <label>
    <input type="checkbox" id="is_private">
    ğŸ”’ ë¹„ë°€ê¸€ë¡œ ì„¤ì •
  </label>
  

  <button onclick="submitEdit()">ìˆ˜ì • ì™„ë£Œ</button>
  <button onclick="history.back()">ì·¨ì†Œ</button>

<script>
const api = 'https://supermax.kr/feed';
const feedId = new URLSearchParams(location.search).get("feedId");
let existingMedia = [];
let removedMedia = [];

if (!feedId) {
  alert("ì˜ëª»ëœ ì ‘ê·¼ì…ë‹ˆë‹¤");
  location.href = 'index.html';
}

async function loadFeed() {
  console.log("ğŸ” feedId:", feedId);
  const token = localStorage.getItem("token");

  try {
    const res = await fetch(`${api}/feeds/${feedId}`, {
      headers: {
        'Authorization': 'Bearer ' + token
      }
    });

    console.log("ğŸ” status:", res.status);
    const feed = await res.json();
    console.log("ğŸ“¦ feed:", feed);
    document.getElementById('content').value = feed.content || '';
updateEditPreview(); // âœ… ë¶ˆëŸ¬ì˜¤ìë§ˆì ë¯¸ë¦¬ë³´ê¸°ì—ë„ ë°˜ì˜


    if (!res.ok || feed.error) {
      alert('í”¼ë“œ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
      return;
    }

    document.getElementById('event').value = feed.event || '';
    document.getElementById('record').value = feed.record || '';
    document.getElementById('content').value = feed.content || '';
    document.getElementById('is_private').checked = feed.is_private == 1;


    try {
      existingMedia = JSON.parse(feed.media_url || '[]');
    } catch {}

    const container = document.getElementById('existing-media');
    existingMedia.forEach(url => {
      const div = document.createElement('div');
      div.className = 'media-preview';
      div.dataset.url = url;
      div.innerHTML = `
        ${url.includes('.mp4')
          ? `<video src="${url}" controls muted></video>`
          : `<img src="${url}" alt="ë¯¸ë¦¬ë³´ê¸°">`}
        <button class="delete-media-btn" onclick="removeMedia('${url}')">âŒ</button>
      `;
      container.appendChild(div);
    });
  } catch (error) {
    console.error("ğŸ”¥ fetch ì˜¤ë¥˜:", error);
    alert("ì„œë²„ í†µì‹  ì˜¤ë¥˜ ë°œìƒ");
  }
}

async function checkAndSaveGoalAchievement(event, record) {
  const token = localStorage.getItem('token');
  const user_id = localStorage.getItem('user_id');

  const headers = {
    "Authorization": "Bearer " + token,
    "Content-Type": "application/json"
  };

  // í˜„ì¬ ëª©í‘œ ë¶ˆëŸ¬ì˜¤ê¸°
  const goalRes = await fetch("https://supermax.kr/feed/my-goals", { headers });
  const goals = await goalRes.json();
  const matched = goals.find(g => g.event === event);
  if (!matched) return;

  const goalValue = parseFloat(matched.goal_record);
  const currentRecord = parseFloat(record);
  if (isNaN(goalValue) || isNaN(currentRecord)) return;

  // âœ… ì—­ë°©í–¥ ì´ë²¤íŠ¸ ì²´í¬ ì¶”ê°€
  const isReverse = ['20mì™•ë³µë‹¬ë¦¬ê¸°', '100më‹¬ë¦¬ê¸°', 'ë‹¬ë¦¬ê¸°'].includes(event);

  // âœ… í˜„ì¬ ê¸°ë¡ë³´ë‹¤ ë†’ì€(ì—­ë°©í–¥ì€ ë‚®ì€) ëª©í‘œ ë©”ë‹¬ ì‚­ì œ ìš”ì²­
  try {
    await fetch("https://supermax.kr/feed/delete-achievements-over-record", {
      method: "POST",
      headers,
      body: JSON.stringify({
        user_id,
        event,
        record: currentRecord,
        isReverse  // âœ… ì„œë²„ì—ì„œ ì´ ì •ë³´ í™œìš© í•„ìš”!
      })
    });
    console.log("ğŸ§¹ ë†’ì€(ë˜ëŠ” ë‚®ì€) ëª©í‘œ ë©”ë‹¬ ì‚­ì œ ì‹œë„ ì™„ë£Œ");
  } catch (err) {
    console.warn("âš ï¸ ë©”ë‹¬ ì‚­ì œ API ì‹¤íŒ¨:", err);
  }

  // âœ… ì •ë°©í–¥ vs ì—­ë°©í–¥ ëª©í‘œ ë‹¬ì„± íŒë‹¨ ì¶”ê°€
  const goalAchieved = isReverse
    ? (currentRecord <= goalValue)   // ì—­ë°©í–¥ (ì‘ê±°ë‚˜ ê°™ìœ¼ë©´ ë‹¬ì„±)
    : (currentRecord >= goalValue);  // ì •ë°©í–¥ (í¬ê±°ë‚˜ ê°™ìœ¼ë©´ ë‹¬ì„±)

  // âœ… í˜„ì¬ ëª©í‘œë¥¼ ë‹¬ì„±í•˜ë©´ ìƒˆ ë©”ë‹¬ ì €ì¥
  if (goalAchieved) {
    const body = {
      user_id,
      event,
      goal_value: goalValue,
      goal_record: currentRecord,
      goal_date: new Date().toISOString().split('T')[0]
    };

    try {
      const res = await fetch("https://supermax.kr/feed/save-achievement-if-new", {
        method: "POST",
        headers,
        body: JSON.stringify(body)
      });

      const result = await res.json();
      if (result.saved) {
        console.log("ğŸ¯ ëª©í‘œ ë‹¬ì„± ê¸°ë¡ ì €ì¥ ì™„ë£Œ!");
      } else {
        console.log("ğŸ“Œ ì´ë¯¸ ì €ì¥ëœ ëª©í‘œê±°ë‚˜ ë¬´ì‹œë¨");
      }
    } catch (err) {
      console.error("ğŸ”¥ ëª©í‘œ ì €ì¥ ì‹¤íŒ¨:", err);
    }
  }
}




function removeMedia(url) {
  removedMedia.push(url);
  document.querySelector(`.media-preview[data-url="${url}"]`).remove();
}

async function submitEdit() {
  const content = document.getElementById('content').value;
  const event = document.getElementById('event').value;
  const record = document.getElementById('record').value;
  const fileInput = document.getElementById('files');
  const token = localStorage.getItem('token');

  const keptMedia = existingMedia.filter(url => !removedMedia.includes(url));

  const formData = new FormData();
  formData.append('feed_id', feedId);
  formData.append('content', content);
  formData.append('event', event);
  formData.append('record', record);
  formData.append('existing_media', JSON.stringify(keptMedia));
  formData.append('is_private', document.getElementById('is_private').checked ? 1 : 0);


  for (let file of fileInput.files) {
    formData.append('files', file);
  }

  try {
    const res = await fetch(`${api}/update-feed`, {
      method: 'PATCH',
      headers: {
        'Authorization': 'Bearer ' + token
      },
      body: formData
    });

    const result = await res.json();
    console.log("âœ… ìˆ˜ì • ê²°ê³¼:", result);

    if (res.ok) {
      await checkAndSaveGoalAchievement(event, record); // âœ… ë©”ë‹¬ ì²´í¬ í˜¸ì¶œ
      alert('í”¼ë“œê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤!');
      location.href = 'feed-detail.html?feedId=' + feedId;
    } else {
      alert('ìˆ˜ì • ì‹¤íŒ¨: ' + (result.error || 'ì˜¤ë¥˜'));
    }
  } catch (e) {
    console.error("âŒ ìˆ˜ì • ìš”ì²­ ì‹¤íŒ¨:", e);
    alert("ìˆ˜ì • ìš”ì²­ ì¤‘ ì˜¤ë¥˜ ë°œìƒ");
  }
}

const contentTextarea = document.getElementById('content');
const previewDiv = document.getElementById('tag-preview');

contentTextarea.addEventListener('input', updateEditPreview);

function updateEditPreview() {
  const value = contentTextarea.value
    .replace(/&/g, "&amp;")
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;")
    .replace(/#([ê°€-í£\w]+)/g, '<span class="hashtag">#$1</span>');

  previewDiv.innerHTML = value + '\n';
}


document.addEventListener('DOMContentLoaded', loadFeed);
</script>
</body>
</html>

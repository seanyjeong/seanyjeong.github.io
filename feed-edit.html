<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>í”¼ë“œ ìˆ˜ì •</title>
  <link href="https://cdn.jsdelivr.net/npm/water.css@2/out/light.min.css" rel="stylesheet">
  <style>
    .media-preview {
      position: relative;
      display: inline-block;
      margin: 8px 4px;
    }
    .media-preview img,
    .media-preview video {
      max-width: 200px;
      max-height: 200px;
      border-radius: 6px;
    }
    .delete-media-btn {
      position: absolute;
      top: 4px;
      right: 4px;
      background: rgba(0,0,0,0.5);
      color: white;
      border: none;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <h2>í”¼ë“œ ìˆ˜ì •</h2>

  <label for="event">ì¢…ëª©</label>
  <select id="event">
    <option value="">-- ì„ íƒí•˜ì„¸ìš” --</option>
    <option value="ì œìë¦¬ë©€ë¦¬ë›°ê¸°">ì œìë¦¬ë©€ë¦¬ë›°ê¸°</option>
    <option value="ë©”ë””ì‹ ë³¼ë˜ì§€ê¸°">ë©”ë””ì‹ ë³¼ë˜ì§€ê¸°</option>
    <option value="ë°°ê·¼ë ¥">ë°°ê·¼ë ¥</option>
    <option value="20mì™•ë³µë‹¬ë¦¬ê¸°">20mì™•ë³µë‹¬ë¦¬ê¸°</option>
    <option value="ìœ—ëª¸ì¼ìœ¼í‚¤ê¸°">ìœ—ëª¸ì¼ìœ¼í‚¤ê¸°</option>
  </select>

  <label for="record">ê¸°ë¡</label>
  <input type="text" id="record" placeholder="ì˜ˆ: 240">

  <label for="content">ë©”ëª¨</label>
  <textarea id="content" style="width: 100%; height: 100px;"></textarea>

  <h4>ê¸°ì¡´ ë¯¸ë””ì–´</h4>
  <div id="existing-media"></div>

  <h4>ìƒˆë¡œìš´ ë¯¸ë””ì–´ ì¶”ê°€</h4>
  <input type="file" id="files" multiple>

  <button onclick="submitEdit()">ìˆ˜ì • ì™„ë£Œ</button>
  <button onclick="history.back()">ì·¨ì†Œ</button>

<script>
const api = 'https://supermax.kr/feed';
const feedId = new URLSearchParams(location.search).get("feedId");
let existingMedia = [];
let removedMedia = [];

if (!feedId) {
  alert("ì˜ëª»ëœ ì ‘ê·¼ì…ë‹ˆë‹¤");
  location.href = 'index.html';
}

async function loadFeed() {
  console.log("ğŸ” feedId:", feedId);
  const token = localStorage.getItem("token");

  try {
    const res = await fetch(`${api}/feeds/${feedId}`, {
      headers: {
        'Authorization': 'Bearer ' + token
      }
    });

    console.log("ğŸ” status:", res.status);
    const feed = await res.json();
    console.log("ğŸ“¦ feed:", feed);

    if (!res.ok || feed.error) {
      alert('í”¼ë“œ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
      return;
    }

    document.getElementById('event').value = feed.event || '';
    document.getElementById('record').value = feed.record || '';
    document.getElementById('content').value = feed.content || '';

    try {
      existingMedia = JSON.parse(feed.media_url || '[]');
    } catch {}

    const container = document.getElementById('existing-media');
    existingMedia.forEach(url => {
      const div = document.createElement('div');
      div.className = 'media-preview';
      div.dataset.url = url;
      div.innerHTML = `
        ${url.includes('.mp4')
          ? `<video src="${url}" controls muted></video>`
          : `<img src="${url}" alt="ë¯¸ë¦¬ë³´ê¸°">`}
        <button class="delete-media-btn" onclick="removeMedia('${url}')">âŒ</button>
      `;
      container.appendChild(div);
    });
  } catch (error) {
    console.error("ğŸ”¥ fetch ì˜¤ë¥˜:", error);
    alert("ì„œë²„ í†µì‹  ì˜¤ë¥˜ ë°œìƒ");
  }
}

function removeMedia(url) {
  removedMedia.push(url);
  document.querySelector(`.media-preview[data-url="${url}"]`).remove();
}

async function submitEdit() {
  const content = document.getElementById('content').value;
  const event = document.getElementById('event').value;
  const record = document.getElementById('record').value;
  const fileInput = document.getElementById('files');
  const token = localStorage.getItem('token');

  const keptMedia = existingMedia.filter(url => !removedMedia.includes(url));

  const formData = new FormData();
  formData.append('feed_id', feedId);
  formData.append('content', content);
  formData.append('event', event);
  formData.append('record', record);
  formData.append('existing_media', JSON.stringify(keptMedia));

  for (let file of fileInput.files) {
    formData.append('files', file);
  }

  try {
    const res = await fetch(`${api}/update-feed`, {
      method: 'PATCH',
      headers: {
        'Authorization': 'Bearer ' + token
      },
      body: formData
    });

    const result = await res.json();
    console.log("âœ… ìˆ˜ì • ê²°ê³¼:", result);

    if (res.ok) {
      alert('í”¼ë“œê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤!');
      location.href = 'feed-detail.html?feedId=' + feedId;
    } else {
      alert('ìˆ˜ì • ì‹¤íŒ¨: ' + (result.error || 'ì˜¤ë¥˜'));
    }
  } catch (e) {
    console.error("âŒ ìˆ˜ì • ìš”ì²­ ì‹¤íŒ¨:", e);
    alert("ìˆ˜ì • ìš”ì²­ ì¤‘ ì˜¤ë¥˜ ë°œìƒ");
  }
}

document.addEventListener('DOMContentLoaded', loadFeed);
</script>
</body>
</html>

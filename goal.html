<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ëª©í‘œ ê¸°ë¡ ì„¤ì •</title>
  <link href="https://cdn.jsdelivr.net/npm/water.css@2/out/light.min.css" rel="stylesheet">
  <style>
    body {
      font-family: 'SUIT', sans-serif;
      padding-bottom: 80px;
      max-width: 600px;
      margin: auto;
    }
    h2 {
      text-align: center;
      margin-top: 1rem;
    }
    .goal-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      margin-bottom: 16px;
    }
    .goal-row label {
      flex: 1;
      font-weight: 600;
    }
    .goal-row input {
      flex: 2;
      padding: 6px;
    }
    .save-btn {
      width: 100%;
      margin-top: 24px;
    }
  </style>
</head>
<body>
  <h2>ğŸ“Œ ì¢…ëª©ë³„ ëª©í‘œ ê¸°ë¡ ì„¤ì •</h2>

  <form id="goalForm">
    <div class="goal-row">
      <label for="goal-ì œìë¦¬ë©€ë¦¬ë›°ê¸°">ì œìë¦¬ë©€ë¦¬ë›°ê¸° (cm)</label>
      <input type="number" id="goal-ì œìë¦¬ë©€ë¦¬ë›°ê¸°" step="any" placeholder="ì˜ˆ: 250">
    </div>
    <div class="goal-row">
      <label for="goal-ë©”ë””ì‹ ë³¼ë˜ì§€ê¸°">ë©”ë””ì‹ ë³¼ë˜ì§€ê¸° (m)</label>
      <input type="number" id="goal-ë©”ë””ì‹ ë³¼ë˜ì§€ê¸°" step="any">
    </div>
    <div class="goal-row">
      <label for="goal-ë°°ê·¼ë ¥">ë°°ê·¼ë ¥ (Kg)</label>
      <input type="number" id="goal-ë°°ê·¼ë ¥" step="any">
    </div>
    <div class="goal-row">
      <label for="goal-20mì™•ë³µë‹¬ë¦¬ê¸°">20mì™•ë³µë‹¬ë¦¬ê¸° (ì´ˆ)</label>
      <input type="number" id="goal-20mì™•ë³µë‹¬ë¦¬ê¸°" step="any">
    </div>
    <div class="goal-row">
      <label for="goal-ìœ—ëª¸ì¼ìœ¼í‚¤ê¸°">ìœ—ëª¸ì¼ìœ¼í‚¤ê¸° (íšŒ)</label>
      <input type="number" id="goal-ìœ—ëª¸ì¼ìœ¼í‚¤ê¸°" step="any">
    </div>
    <div class="goal-row">
        <label for="goal-ì¢Œì „êµ´">ì¢Œì „êµ´(Cm)</label>
        <input type="number" id="goal-ì¢Œì „êµ´" step="any">
      </div>

    <button type="submit" class="save-btn">ğŸ’¾ ì €ì¥í•˜ê¸°</button>
  </form>

  <script>
    const api = 'https://supermax.kr/feed';
    const token = localStorage.getItem('token');
    const headers = {
      'Authorization': 'Bearer ' + token,
      'Content-Type': 'application/json'
    };

    const events = ['ì œìë¦¬ë©€ë¦¬ë›°ê¸°', 'ë©”ë””ì‹ ë³¼ë˜ì§€ê¸°', 'ë°°ê·¼ë ¥', '20mì™•ë³µë‹¬ë¦¬ê¸°', 'ìœ—ëª¸ì¼ìœ¼í‚¤ê¸°','ì¢Œì „êµ´'];

    // ì¢…ëª©ë³„ ìµœì†Œ í–¥ìƒ ê¸°ì¤€ ì„¤ì •
const minImprovementMap = {
  'ì œìë¦¬ë©€ë¦¬ë›°ê¸°': 5,        // cm
  'ë°°ê·¼ë ¥': 10,               // kg
  'ìœ—ëª¸ì¼ìœ¼í‚¤ê¸°': 3,          // íšŒ
  'ë©”ë””ì‹ ë³¼ë˜ì§€ê¸°': 0.5,      // m
  'ì¢Œì „êµ´': 3,                // cm
  '20mì™•ë³µë‹¬ë¦¬ê¸°': 0.1        // ì´ˆ (ì—­ë°©í–¥)
};
const minGoalMap = {
  'ë‚¨': {
    'ì œìë¦¬ë©€ë¦¬ë›°ê¸°': 265,
    'ë°°ê·¼ë ¥': 200,
    'ìœ—ëª¸ì¼ìœ¼í‚¤ê¸°': 65,
    'ë©”ë””ì‹ ë³¼ë˜ì§€ê¸°': 10,
    'ì¢Œì „êµ´': 15,
    '20mì™•ë³µë‹¬ë¦¬ê¸°': 15
  },
  'ì—¬': {
    'ì œìë¦¬ë©€ë¦¬ë›°ê¸°': 200,
    'ë°°ê·¼ë ¥': 120,
    'ìœ—ëª¸ì¼ìœ¼í‚¤ê¸°': 55,
    'ë©”ë””ì‹ ë³¼ë˜ì§€ê¸°': 7,
    'ì¢Œì „êµ´': 18,
    '20mì™•ë³µë‹¬ë¦¬ê¸°': 17.0
  }
};

// âœ… ì¢…ëª©ë³„ ì†Œìˆ«ì  ì²˜ë¦¬ ìë¦¿ìˆ˜ ì¶”ê°€
const decimalPlacesMap = {
  'ì œìë¦¬ë©€ë¦¬ë›°ê¸°': 0,
  'ë°°ê·¼ë ¥': 1,
  'ìœ—ëª¸ì¼ìœ¼í‚¤ê¸°': 0,
  'ë©”ë””ì‹ ë³¼ë˜ì§€ê¸°': 1,
  'ì¢Œì „êµ´': 1,
  '20mì™•ë³µë‹¬ë¦¬ê¸°': 2
};


let userGender = 'ë‚¨'; // ê¸°ë³¸ê°’



async function fetchUserGender() {
  const res = await fetch(`${api}/user-info`, {
    method: 'POST',
    headers,
    body: JSON.stringify({ user_id: localStorage.getItem("user_id") })
  });

  if (res.ok) {
    const data = await res.json();
    const korMap = { male: 'ë‚¨', female: 'ì—¬' };
    userGender = korMap[data.gender] || 'ë‚¨';
  }
}

async function fetchAIRecommendedGoal(event, records) {
  const res = await fetch('https://supermax.kr/feed/get-ai-recommended-goal', {
    method: 'POST',
    headers,
    body: JSON.stringify({ records })
  });

  if (res.ok) {
    const data = await res.json();
    return data; // { recommended_goal, confidence }
  } else {
    console.error('AI ì¶”ì²œ ì‹¤íŒ¨:', await res.text());
    return null;
  }
}


async function fetchGoals() {
  // 1. í˜„ì¬ ëª©í‘œ ë¶ˆëŸ¬ì˜¤ê¸°
  const goalRes = await fetch(`${api}/my-goals`, { headers });
  const goalData = await goalRes.json();
  const goalMap = Object.fromEntries(goalData.map(g => [g.event, parseFloat(g.goal_record)]));

  // 2. ëª©í‘œê°’ inputì— í‘œì‹œ
  goalData.forEach(g => {
    const input = document.getElementById(`goal-${g.event}`);
    if (input) {
      const decimals = decimalPlacesMap[g.event] ?? 0;
      input.value = parseFloat(g.goal_record).toFixed(decimals);
    }
  });

  // 3. ê³¼ê±° ë‹¬ì„±ê¸°ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
  const achievedRes = await fetch(`${api}/my-achievements`, { headers });
  const achievedData = await achievedRes.json();

  // 4. ë‹¬ì„± ì¢…ëª©ë§ˆë‹¤ AI ì¶”ì²œ í‘œì‹œ
  for (const ach of achievedData) {
    const event = ach.event;
    const goalRecord = parseFloat(ach.goal_record); // ì˜ˆì „ì— ë‹¬ì„±í–ˆë˜ ê¸°ë¡
    const currentGoal = goalMap[event];
    if (isNaN(goalRecord) || isNaN(currentGoal)) continue;

    const isReverse = ['20mì™•ë³µë‹¬ë¦¬ê¸°', '100më‹¬ë¦¬ê¸°', 'ë‹¬ë¦¬ê¸°'].includes(event);

    // âœ… í˜„ì¬ ëª©í‘œë¥¼ ì´ë¯¸ ë‹¬ì„±í•œ ê²½ìš°ì—ë§Œ ì¶”ì²œ í‘œì‹œ
    const stillAchieved = isReverse
      ? goalRecord <= currentGoal
      : goalRecord >= currentGoal;
    if (!stillAchieved) continue;

    const recordsData = [
      { record: parseFloat(ach.goal_value) },
      { record: goalRecord }
    ];

    const recommendation = await fetchAIRecommendedGoal(event, recordsData);

    if (recommendation) {
      const input = document.getElementById(`goal-${event}`);
      if (input) {
        const decimals = decimalPlacesMap[event] ?? 0;
        let recommendedGoal = parseFloat(recommendation.recommended_goal);

        const minDiff = minImprovementMap[event] || (isReverse ? 0.1 : 5);

        // âœ… ìµœì†Œ í–¥ìƒ ì¡°ê±´ ë³´ì •
        if (isReverse) {
          if (goalRecord - recommendedGoal < minDiff) {
            recommendedGoal = goalRecord - minDiff;
          }
        } else {
          if (recommendedGoal - goalRecord < minDiff) {
            recommendedGoal = goalRecord + minDiff;
          }
        }

        // âœ… ì„±ë³„ë³„ ìµœì†Œ ëª©í‘œ ì¡°ê±´ ì ìš©
        const minGoal = minGoalMap[userGender]?.[event];
        if (minGoal !== undefined) {
          if (isReverse && recommendedGoal > minGoal) {
            recommendedGoal = minGoal;
          } else if (!isReverse && recommendedGoal < minGoal) {
            recommendedGoal = minGoal;
          }
        }

        recommendedGoal = recommendedGoal.toFixed(decimals);

        const parent = input.parentElement;
        const aiClass = `ai-recommendation-${event}`;
        const oldRecDiv = parent.parentElement.querySelector(`.${aiClass}`);
        if (oldRecDiv) oldRecDiv.remove();

        const recDiv = document.createElement('div');
        recDiv.className = `ai-recommendation ${aiClass}`;
        recDiv.style.color = "#007bff";
        recDiv.style.marginTop = '4px';
        recDiv.innerHTML = `
          ğŸ‘¨â€ğŸ’»â€‹ AI ì¶”ì²œ ëª©í‘œ: <strong>${recommendedGoal}${getUnit(event)}</strong> 
          <br>
          <small>ìµœê·¼ ê¸°ë¡ ì¶”ì´ë¥¼ ê³ ë ¤í–ˆì„ ë•Œ ê°€ì¥ í˜„ì‹¤ì ì¸ ëª©í‘œì…ë‹ˆë‹¤.</small>
        `;

        recDiv.style.cursor = 'pointer';
        recDiv.onclick = () => input.value = recommendedGoal;

        parent.insertAdjacentElement('beforebegin', recDiv);
      }
    }
  }
}






 async function saveGoals(e) {
  e.preventDefault();

  const goalRes = await fetch(`${api}/my-goals`, { headers });
  const achievedRes = await fetch(`${api}/my-achievements`, { headers });

  const currentGoals = await goalRes.json();  // [{event, goal_record}]
  const achievedGoals = await achievedRes.json(); // [{event, goal_value}]

  const currentGoalMap = Object.fromEntries(currentGoals.map(g => [g.event, g.goal_record]));
  const achievedMap = Object.fromEntries(achievedGoals.map(g => [g.event, g.goal_value]));

  const goals = [];

  for (let event of events) {
    const inputEl = document.getElementById(`goal-${event}`);
    const newVal = parseFloat(inputEl.value);
    if (isNaN(newVal)) continue;

    const oldGoal = parseFloat(currentGoalMap[event] || 0);
const achievedRecord = parseFloat(achievedMap[event] || 0);
const achieved = achievedMap[event] !== undefined;

    const isReverse = ['20mì™•ë³µë‹¬ë¦¬ê¸°', '100më‹¬ë¦¬ê¸°', 'ë‹¬ë¦¬ê¸°'].includes(event);

    if (achieved) {
  const achievedRecord = parseFloat(achievedMap[event]); // âœ… ë‹¬ì„±í•œ ê¸°ë¡ ê¸°ì¤€

  // 1. ëª©í‘œë¥¼ ë” ë‚®ì¶”ë ¤ëŠ” ê²½ìš° â†’ ë‹¬ì„± ê¸°ë¡ë³´ë‹¤ ë‚®ê²Œ ì„¤ì • âŒ
  if (
    (!isReverse && newVal < achievedRecord) ||
    (isReverse && newVal > achievedRecord)
  ) {
    alert(`ğŸš« [${event}] ì´ë¯¸ ë‹¬ì„±í•œ ê¸°ë¡(${achievedRecord}${getUnit(event)})ë³´ë‹¤ ë‚®ê²Œ ì„¤ì •í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤!`);
    return;
  }

  // 2. ë„ˆë¬´ ì‚´ì§ë§Œ í–¥ìƒì‹œí‚¨ ê²½ìš° â†’ ì˜ë¯¸ ìˆëŠ” í–¥ìƒë§Œ í—ˆìš©
  const minDiff = minImprovementMap[event] || (isReverse ? 0.1 : 5);
  const diff = Math.abs(newVal - achievedRecord);
const notEnough = isReverse
  ? (newVal >= achievedRecord || diff < minDiff)
  : (newVal <= achievedRecord || diff < minDiff);


  if (notEnough) {
    alert(`âš ï¸ [${event}] ê¸°ì¡´ ë‹¬ì„± ê¸°ë¡(${achievedRecord}${getUnit(event)})ë³´ë‹¤ ìµœì†Œ ${minDiff}${getUnit(event)} ${isReverse ? 'ì¤„ì—¬ì•¼' : 'ì˜¬ë ¤ì•¼'} ì˜ë¯¸ ìˆì–´ìš”.`);
    return;
  }
}



const minGoal = minGoalMap[userGender]?.[event];
if (minGoal !== undefined) {
  const isBelow = isReverse ? newVal > minGoal : newVal < minGoal;
  if (isBelow) {
    alert(`ğŸš« [${event}] ${userGender} ìµœì†Œ ëª©í‘œëŠ” ${minGoal}${getUnit(event)} ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.`);
    return;
  }
}




    // ìœ íš¨í•˜ë©´ ì¶”ê°€
    goals.push({ event, goal_record: newVal });
  }

  // ì €ì¥
  const res = await fetch(`${api}/update-goals`, {
    method: 'POST',
    headers,
    body: JSON.stringify({ goals })
  });

  if (res.ok) {
    alert("ğŸ‰ ëª©í‘œ ê¸°ë¡ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!");
    location.href = 'profile-feed.html';
  } else {
    alert("âŒ ì €ì¥ ì‹¤íŒ¨");
  }
}

function getUnit(event) {
  if (event.includes('ë©€ë¦¬') || event.includes('ì¢Œì „êµ´')) return 'cm';
  if (event.includes('ë°°ê·¼')) return 'kg';
  if (event.includes('ë‹¬ë¦¬ê¸°')) return 'ì´ˆ';
  if (event.includes('ë©”ë””ì‹ ')) return 'm';
  if (event.includes('ìœ—ëª¸')) return 'íšŒ';
  return '';
}



    document.getElementById('goalForm').addEventListener('submit', saveGoals);
    fetchUserGender().then(() => {
  fetchGoals();
});
  </script>
</body>
</html>

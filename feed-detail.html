<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>í”¼ë“œ ìƒì„¸ë³´ê¸°</title>
  <link href="https://cdn.jsdelivr.net/npm/water.css@2/out/light.min.css" rel="stylesheet">
  <link rel="stylesheet" href="css/reset.css">
  <link rel="stylesheet" href="css/feed.css">
  <link rel="stylesheet" href="css/comment.css">
  <link rel="stylesheet" href="css/swiper.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css">

  <style>
    .emoji-trigger-wrapper input[type="text"] {
      width: 100% !important;
      max-width: 100%;
      box-sizing: border-box;
    }
    .top-nav {
    position: sticky;
    top: 0;
    background: #fff;
    z-index: 10;
    display: flex;
    align-items: center;
    padding: 8px 16px;
    border-bottom: 1px solid #eee;
  }

  .back-btn {
    background: none;
    border: none;
    font-size: 1.1rem;
    cursor: pointer;
    margin-right: 10px;
    padding: 6px 8px;
    border-radius: 6px;
  }

  .nav-title {
    font-weight: 600;
    font-size: 1rem;
  }
  </style>
</head>
<body>
  <script src="https://cdn.jsdelivr.net/npm/@joeattardi/emoji-button@4.6.2/dist/emoji-button.min.js"></script>

<!-- âœ… í”¼ë“œ ìƒì„¸ ì˜ì—­ -->
<section style="padding-bottom: 80px;">
  <div class="top-nav">
    <button class="back-btn" onclick="history.back()">â†</button>
    <span class="nav-title">ì´ì „</span>
  </div>
  
  <div id="feed-detail"></div>
</section>

<!-- âœ… í•˜ë‹¨ ê³ ì • ë„¤ë¹„ê²Œì´ì…˜ -->
<div class="bottom-nav">
  <button onclick="location.href='index.html'">ğŸ </button>
  <button onclick="alert('ğŸ” ê²€ìƒ‰ ì¤€ë¹„ì¤‘')">ğŸ”</button>
  <button onclick="location.href='upload.html'" class="plus-btn">â•</button>
  <button onclick="alert('ğŸ¬ ë¦´ìŠ¤ ì¤€ë¹„ì¤‘')">ğŸ¬</button>
  <button id="profile-nav-btn" onclick="location.href='profile-feed.html'"><img id="nav-profile-img" src="https://placehold.co/32x32" alt="ë‚´ í”„ë¡œí•„" style="width: 32px; height: 32px; border-radius: 50%;"></button>
</div>

<!-- âœ… Swiper + ì „ì—­ ëŒ“ê¸€ ê¸°ëŠ¥ í¬í•¨ js ë¶ˆëŸ¬ì˜¤ê¸° -->
<script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>
<script>

</script>
<script src="js/main.js"></script>
<script>
  async function loadMyProfileImageForNav() {
    const token = localStorage.getItem("token");
    const userId = localStorage.getItem("user_id");

    if (!token || !userId) return;

    try {
      const res = await fetch("https://supermax.kr/feed/user-info", {
        method: "POST",
        headers: {
          "Authorization": "Bearer " + token,
          "Content-Type": "application/json"
        },
        body: JSON.stringify({ user_id: userId })
      });

      if (!res.ok) return;

      const data = await res.json();
      document.getElementById("nav-profile-img").src = data.profile_image || "https://placehold.co/32x32";
    } catch (e) {
      console.warn("í•˜ë‹¨ ë‚´ í”„ë¡œí•„ ì´ë¯¸ì§€ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨", e);
    }
  }

  document.addEventListener("DOMContentLoaded", () => {
    loadMyProfileImageForNav();
  });
</script>

<script>
  function getQueryParam(param) {
    const urlParams = new URLSearchParams(window.location.search);
    return urlParams.get(param);
  }

  async function loadFeedDetail() {
  const feedId = getQueryParam('feedId');
  if (!feedId) return alert('í”¼ë“œ IDê°€ ì—†ìŠµë‹ˆë‹¤.');

  // ğŸ”¹ í”¼ë“œ ì •ë³´ ë¶ˆëŸ¬ì˜¤ê¸°
  const res = await fetch(`https://supermax.kr/feed/feeds/${feedId}`);
  const feed = await res.json();
  if (feed.error) return alert('í”¼ë“œ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');

  // ğŸ”¹ í•´ë‹¹ í”¼ë“œ ì‘ì„±ì ì •ë³´ ë¶ˆëŸ¬ì˜¤ê¸°
  const userRes = await fetch("https://supermax.kr/feed/user-info", {
    method: "POST",
    headers: {
      "Authorization": "Bearer " + localStorage.getItem("token"),
      "Content-Type": "application/json"
    },
    body: JSON.stringify({ user_id: feed.user_id })
  });

  const userData = await userRes.json();

  const container = document.getElementById('feed-detail');
  const userName = userData.name || 'ì‚¬ìš©ì';
  const profileImage = userData.profile_image || 'https://placehold.co/40x40';

  let mediaHTML = '';
  try {
    const mediaArray = JSON.parse(feed.media_url || '[]');
    if (Array.isArray(mediaArray) && mediaArray.length > 0) {
      const slides = mediaArray.map(url => `
        <div class="swiper-slide">
          ${url.includes('.mp4')
            ? `<video class="feed-video" controls muted preload="none" src="${url}"></video>`
            : `<img src="${url}" alt="í”¼ë“œ ì´ë¯¸ì§€">`}
        </div>`).join('');

      const swiperId = `swiper-${feed.id}`;
      mediaHTML = `
        <div class="swiper" id="${swiperId}">
          <div class="swiper-wrapper">${slides}</div>
          <div class="swiper-pagination"></div>
          <div class="swiper-button-prev"></div>
          <div class="swiper-button-next"></div>
        </div>`;

      setTimeout(() => {
        const wrapper = document.querySelector(`#${swiperId} .swiper-wrapper`);
        if (wrapper && wrapper.children.length > 1) {
          new Swiper(`#${swiperId}`, {
            loop: true,
            pagination: { el: `#${swiperId} .swiper-pagination` },
            navigation: {
              nextEl: `#${swiperId} .swiper-button-next`,
              prevEl: `#${swiperId} .swiper-button-prev`
            }
          });
        }
      }, 0);
    }
  } catch (e) {
    console.error('âŒ ë¯¸ë””ì–´ íŒŒì‹± ì˜¤ë¥˜:', e);
  }

  container.innerHTML = `
    <div class="feed">
      <div class="profile clickable-user" onclick="location.href='profile-feed.html?userId=${feed.user_id}'">
        <img src="${profileImage}" alt="í”„ë¡œí•„">
        <div style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
          <strong>${userName}</strong>
          <span class="timestamp" style="font-size: 0.85rem; color: #888;">${getRelativeTime(feed.created_at)}</span>
        </div>
      </div>
      <p>${feed.content || ''}</p>
      ${mediaHTML}
      <div class="actions">
        <button class="like-btn" id="like-btn-${feed.id}" onclick="likeFeed(${feed.id})">â¤ï¸ ${feed.like_count || 0}</button>
        <button id="comment-btn-${feed.id}" onclick="commentFeed(${feed.id}, true)" class="icon-btn">
          <span>ğŸ’¬</span> <span id="comment-count-${feed.id}">${feed.comment_count || 0}</span>
        </button>
      </div>
      <div id="comments-${feed.id}" class="comments"></div>
    </div>
  `;

  // âœ… ëŒ“ê¸€ê¹Œì§€ ë¡œë”©
  await window.commentFeed(feed.id, true);
}


  window.setupEmojiPicker = function (inputId, triggerEl) {
    if (!triggerEl._emojiPickerInstance) {
      const picker = new EmojiButton({ position: 'top-start', zIndex: 9999 });

      picker.on('emoji', emoji => {
        const input = document.getElementById(inputId);
        if (input) {
          input.value += emoji;
          input.focus();
        }
        picker.hidePicker();
      });

      triggerEl._emojiPickerInstance = picker;
    }
    triggerEl._emojiPickerInstance.togglePicker(triggerEl);
  };

  document.addEventListener("DOMContentLoaded", () => {
  try {
    const anchor = document.getElementById('scroll-anchor');
    if (anchor) observer.observe(anchor);
  } catch (e) {
    // âŒ ì½˜ì†”ì— ì•„ë¬´ê²ƒë„ ì•ˆ ì°íˆê²Œ ë¬´ì‹œ!
  }

  loadFeedDetail();
});

</script>
</body>
</html>

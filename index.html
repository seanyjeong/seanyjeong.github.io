<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>STAC</title>
  <link href="https://cdn.jsdelivr.net/npm/water.css@2/out/light.min.css" rel="stylesheet">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css" />
<link href="https://fonts.googleapis.com/css2?family=SUIT:wght@400;600;700&display=swap" rel="stylesheet">


<link rel="manifest" href="./manifest.json">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="MAX LOUNGE">
<link rel="apple-touch-icon" href="https://raw.githubusercontent.com/seanyjeong/maxfeed/main/icon-180.png">

<link rel="stylesheet" href="css/reset.css">

<link rel="stylesheet" href="css/feed.css">
<link rel="stylesheet" href="css/comment.css">
<link rel="stylesheet" href="css/emoji.css">
<link rel="stylesheet" href="css/swiper.css">

<style>
.bottom-nav {
  position: fixed;
  bottom: 0;
  left: 0;
  width: 100%;
  background: #fff;
  display: flex;
  justify-content: space-around; /* ✅ 버튼 균등하게 배치 */
  align-items: center;
  padding: 6px 0;
  border-top: 1px solid #ccc;
  z-index: 999;
}

.bottom-nav button {
  background: none;
  border: none;
  font-size: 1.2rem;  /* ✅ 적당한 크기로 줄이기 */
  padding: 4px;
  flex: 1;
  text-align: center;
}
.bottom-nav .plus-btn {
  font-size: 1.6rem;       /* 가운데만 살짝 강조 */
  transform: translateY(-4px); /* 약간 위로 띄우면 감성 😎 */
}


  @keyframes fadeinout {
    0% { opacity: 0; transform: translateY(10px); }
    10% { opacity: 1; transform: translateY(0); }
    90% { opacity: 1; }
    100% { opacity: 0; transform: translateY(-10px); }
  }

</style>

</head>
<body>

    <!-- Swiper JS -->
<script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/lucide@0.260.0/dist/umd/lucide.min.js"></script>

<!-- 관리자 전용 버튼 (JS로 조건부 렌더링됨) -->
<button id="admin-button" onclick="location.href='admin.html'" title="관리자 페이지"
  style="display: none;">
  🛠 관리자
</button>


<!-- ✅ index.html 중간 피드 section 위에 추가 -->
<div class="page-title" style="display: flex; justify-content: space-between; align-items: center;">
  <!-- 비회원용 로그인/회원가입 버튼 -->


  <!-- 타이틀 + 슬로건 묶음 -->
 <div style="margin: 6px 18px;">
  <img src="https://github.com/seanyjeong/maxtargram/blob/main/stac2.png?raw=true"
       alt="STAC"
       style="height:200px; display: block; margin-bottom: -60px; margin-left: -25px; margin-top: -65px;" />
</div>




  <!-- 🔔 알림 아이콘 영역 -->
  <div id="notif-icon-wrapper" style="position: relative; cursor: pointer;" onclick="openNotificationCenter()">
    <div id="notif-dropdown" style="
  display: none;
  position: absolute;
  top: 40px;
  right: 0;
  background: white;
  border: 1px solid #ccc;
  box-shadow: 0 4px 12px rgba(0,0,0,0.1);
  border-radius: 8px;
  width: 250px;
  max-height: 300px;
  overflow-y: auto;
  z-index: 9999;
"></div>

    <!-- 벨 아이콘 SVG -->
    <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none"
      stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
      class="lucide lucide-bell">
      <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/>
      <path d="M13.73 21a2 2 0 0 1-3.46 0"/>
    </svg>

    <!-- 숫자 뱃지 -->
    <span id="notif-count" style="
      position: absolute;
      top: -6px; right: -6px;
      background: red;
      color: white;
      font-size: 0.7rem;
      font-weight: bold;
      border-radius: 50%;
      padding: 2px 6px;
      display: none;
    ">0</span>
  </div>
</div>
<div id="guest-actions" style="display:none; margin-top: 10px; text-align: center;">
  <button onclick="location.href='login.html'">🔐 로그인</button>
  <button onclick="location.href='register.html'">📝 회원가입</button>
</div>

  







<!-- 📌 피드 목록 -->
<section>
  <h3 id="feeds-title">📌 피드 목록</h3>
  <div id="feeds"></div>
</section>
<div id="scroll-anchor"></div> <!-- 🔥 무한스크롤 앵커 -->


<script src="js/main.js"></script>

<script>

function openNotificationCenter() {
  const dropdown = document.getElementById("notif-dropdown");
  const isOpen = dropdown.style.display === "block";
  dropdown.style.display = isOpen ? "none" : "block";

  if (!isOpen) {
    if (!localStorage.getItem("notifOpened")) {
      localStorage.setItem("notifOpened", "true");
      console.log("✅ notifOpened 저장됨!");
    }
    loadNotifications();
  }
}

async function loadNotifications() {
  const res = await fetch("https://supermax.kr/feed/my-notifications", {
    method: "POST",
    headers: {
      Authorization: "Bearer " + localStorage.getItem("token"),
      "Content-Type": "application/json"
    },
    body: JSON.stringify({})
  });

  const notifs = await res.json();  // 🔥 이 줄 꼭 있어야 함!!!

  const container = document.getElementById("notif-dropdown");

  if (notifs.length === 0) {
    container.innerHTML = "<div style='padding:10px; color:#888;'>알림이 없습니다</div>";
    return;
  }

  container.innerHTML = `
    <div style="padding: 8px 10px; font-size: 0.85rem; text-align: right; border-bottom: 1px solid #eee;">
      <span onclick="clearNotifications()" style="cursor: pointer; color: #888;">🗑 알림 지우기</span>
    </div>
  ` + notifs.map(n => `
    <div onclick="goToFeed(${n.feed_id}, ${n.id})"
         style="padding: 10px; border-bottom: 1px solid #eee; cursor: pointer;">
      ${n.message}
    </div>
  `).join('');
}


async function clearNotifications() {
  await fetch("https://supermax.kr/feed/clear-notifications", {
    method: "POST",
    headers: {
      Authorization: "Bearer " + localStorage.getItem("token"),
      "Content-Type": "application/json"
    }
  });

  // 바로 UI 초기화
  const container = document.getElementById("notif-dropdown");
  container.innerHTML = "<div style='padding:10px; color:#888;'>알림이 없습니다</div>";
  
  // 카운트 뱃지도 숨기기
  document.getElementById("notif-count").style.display = "none";
}


async function goToFeed(feedId, notifId) {
  // 읽음 처리
  await fetch("https://supermax.kr/feed/read-notification", {
    method: "POST",
    headers: {
      Authorization: "Bearer " + localStorage.getItem("token"),
      "Content-Type": "application/json"
    },
    body: JSON.stringify({ id: notifId })
  });

  location.href = `feed-detail.html?feedId=${feedId}`;
}




async function checkNotifications() {
  try {
    const res = await fetch("https://supermax.kr/feed/my-notifications", {
      method: "POST",
      headers: {
        Authorization: "Bearer " + localStorage.getItem("token"),
        "Content-Type": "application/json"
      },
      body: JSON.stringify({})
    });
    const notifs = await res.json();

    const countEl = document.getElementById("notif-count");
    const prevCount = parseInt(localStorage.getItem("prevNotifCount") || "0");

    if (notifs.length > 0) {
      countEl.style.display = "inline-block";
      countEl.innerText = notifs.length;

      // ✅ 새로 생긴 알림이 있다면 토스트 띄우기
      if (notifs.length > prevCount) {
        showToast(`🔔 새로운 알림 ${notifs.length}개 도착!`);
      }

      // ✅ 현재 개수를 저장
      localStorage.setItem("prevNotifCount", notifs.length.toString());
    } else {
      countEl.style.display = "none";
      localStorage.setItem("prevNotifCount", "0");
    }
  } catch (e) {
    console.warn("❌ 알림 체크 실패", e);
  }
}





setInterval(checkNotifications, 10000); // 10초마다 체크





  async function loadMyProfileImageForNav() {
  const userId = localStorage.getItem("user_id");
  if (!userId) return;

  const userData = await secureFetchUserInfo(userId);
  if (!userData) return;

  document.getElementById("nav-profile-img").src = userData.profile_image || "https://placehold.co/32x32";
}


document.addEventListener("DOMContentLoaded", async () => {
  checkNotifications(); 
  loadMyProfileImageForNav();

  const token = localStorage.getItem("token");

  // ✅ ✅ ✅ 이 부분 추가!
  if (!token) {
    // 비회원 상태 처리
    document.getElementById("guest-actions").style.display = "block";

    // 업로드 버튼 비활성화
    const uploadBtn = document.querySelector('.bottom-nav button[onclick*="upload.html"]');
    if (uploadBtn) {
      uploadBtn.onclick = () => {
        alert("로그인 후 이용 가능합니다 😊");
        location.href = 'login.html';
      };
    }

    // 알림 벨 비활성화
    const notifIcon = document.getElementById("notif-icon-wrapper");
    if (notifIcon) {
      notifIcon.onclick = () => {
        alert("로그인 후 알림 확인 가능해요 😊");
        location.href = 'login.html';
      };
    }

    // 관리자 버튼 숨김
    document.getElementById("admin-button").style.display = "none";
    return; // ✅ 관리자 체크 아래 코드 실행 안 하도록 리턴!
  }

  // 관리자 체크는 로그인한 경우에만
  try {
    const payload = JSON.parse(atob(token.split('.')[1]));
    if (payload?.username === 'admin') {
      document.getElementById("admin-button").style.display = "inline-block";
    }
  } catch (e) {
    console.warn("❌ 관리자 토큰 확인 실패:", e);
  }
});




  lucide.createIcons();


  
</script>

<!-- 📌 index.html 마지막에 추가 (</body> 바로 위) -->
<div class="bottom-nav">
  <button onclick="resetFeedState('/feeds'); loadFeeds('/feeds')" title="홈">
    <!-- home.svg -->
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-house"><path d="M15 21v-8a1 1 0 0 0-1-1h-4a1 1 0 0 0-1 1v8"/><path d="M3 10a2 2 0 0 1 .709-1.528l7-5.999a2 2 0 0 1 2.582 0l7 5.999A2 2 0 0 1 21 10v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/></svg>
  </button>

  <button onclick="location.href='upload.html'" title="업로드">
    <!-- plus.svg -->
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-plus"><path d="M5 12h14"/><path d="M12 5v14"/></svg>
  </button>
  <button onclick="location.href='record-chart.html'" title="기록차트">
    <!-- video.svg -->
  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-chart-spline"><path d="M3 3v16a2 2 0 0 0 2 2h16"/><path d="M7 16c.5-2 1.5-7 4-7 2 0 2 3 4 3 2.5 0 4.5-5 5-7"/></svg>
</button>
  <button onclick="location.href='profile-feed.html'">
    <img id="nav-profile-img" src="https://placehold.co/32x32" alt="내 프로필" style="width: 32px; height: 32px; border-radius: 50%;" />
  </button>
  
</div>



</body>
</html>

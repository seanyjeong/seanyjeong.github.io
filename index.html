<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>STAC</title>
  <link href="https://cdn.jsdelivr.net/npm/water.css@2/out/light.min.css" rel="stylesheet">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css" />
<link href="https://fonts.googleapis.com/css2?family=SUIT:wght@400;600;700&display=swap" rel="stylesheet">


<link rel="manifest" href="./manifest.json">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="MAX LOUNGE">
<link rel="apple-touch-icon" href="https://raw.githubusercontent.com/seanyjeong/maxfeed/main/icon-180.png">

<link rel="stylesheet" href="css/reset.css">

<link rel="stylesheet" href="css/feed.css">
<link rel="stylesheet" href="css/comment.css">
<link rel="stylesheet" href="css/emoji.css">
<link rel="stylesheet" href="css/swiper.css">

<style>
.bottom-nav {
  position: fixed;
  bottom: 0;
  left: 0;
  width: 100%;
  background: #fff;
  display: flex;
  justify-content: space-around; /* âœ… ë²„íŠ¼ ê· ë“±í•˜ê²Œ ë°°ì¹˜ */
  align-items: center;
  padding: 6px 0;
  border-top: 1px solid #ccc;
  z-index: 999;
}

.bottom-nav button {
  background: none;
  border: none;
  font-size: 1.2rem;  /* âœ… ì ë‹¹í•œ í¬ê¸°ë¡œ ì¤„ì´ê¸° */
  padding: 4px;
  flex: 1;
  text-align: center;
}
.bottom-nav .plus-btn {
  font-size: 1.6rem;       /* ê°€ìš´ë°ë§Œ ì‚´ì§ ê°•ì¡° */
  transform: translateY(-4px); /* ì•½ê°„ ìœ„ë¡œ ë„ìš°ë©´ ê°ì„± ğŸ˜ */
}


  @keyframes fadeinout {
    0% { opacity: 0; transform: translateY(10px); }
    10% { opacity: 1; transform: translateY(0); }
    90% { opacity: 1; }
    100% { opacity: 0; transform: translateY(-10px); }
  }

</style>

</head>
<body>

    <!-- Swiper JS -->
<script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/lucide@0.260.0/dist/umd/lucide.min.js"></script>

<!-- ê´€ë¦¬ì ì „ìš© ë²„íŠ¼ (JSë¡œ ì¡°ê±´ë¶€ ë Œë”ë§ë¨) -->
<button id="admin-button" onclick="location.href='admin.html'" title="ê´€ë¦¬ì í˜ì´ì§€"
  style="display: none;">
  ğŸ›  ê´€ë¦¬ì
</button>


<!-- âœ… index.html ì¤‘ê°„ í”¼ë“œ section ìœ„ì— ì¶”ê°€ -->
<div class="page-title" style="display: flex; justify-content: space-between; align-items: center;">
  <!-- ë¹„íšŒì›ìš© ë¡œê·¸ì¸/íšŒì›ê°€ì… ë²„íŠ¼ -->


  <!-- íƒ€ì´í‹€ + ìŠ¬ë¡œê±´ ë¬¶ìŒ -->
 <!-- STAC ë¡œê³  ì´ë¯¸ì§€ (ê°€ë¡œí˜•) -->
 <div style="text-align: left; margin: 8px 4px 4px;">
  <img src="https://github.com/seanyjeong/maxtargram/blob/main/stack.png?raw=true" 
       alt="STAC ë¡œê³ " 
       style="max-width: 320px; width: 70%; height: auto;" />
</div>




  <!-- ğŸ”” ì•Œë¦¼ ì•„ì´ì½˜ ì˜ì—­ -->
  <div id="notif-icon-wrapper" style="position: relative; cursor: pointer;" onclick="openNotificationCenter()">
    <div id="notif-dropdown" style="
  display: none;
  position: absolute;
  top: 40px;
  right: 0;
  background: white;
  border: 1px solid #ccc;
  box-shadow: 0 4px 12px rgba(0,0,0,0.1);
  border-radius: 8px;
  width: 250px;
  max-height: 300px;
  overflow-y: auto;
  z-index: 9999;
"></div>

    <!-- ë²¨ ì•„ì´ì½˜ SVG -->
    <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none"
      stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
      class="lucide lucide-bell">
      <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/>
      <path d="M13.73 21a2 2 0 0 1-3.46 0"/>
    </svg>

    <!-- ìˆ«ì ë±ƒì§€ -->
    <span id="notif-count" style="
      position: absolute;
      top: -6px; right: -6px;
      background: red;
      color: white;
      font-size: 0.7rem;
      font-weight: bold;
      border-radius: 50%;
      padding: 2px 6px;
      display: none;
    ">0</span>
  </div>
</div>
<div id="guest-actions" style="display:none; margin-top: 10px; text-align: center;">
  <button onclick="location.href='login.html'">ğŸ” ë¡œê·¸ì¸</button>
  <button onclick="location.href='register.html'">ğŸ“ íšŒì›ê°€ì…</button>
</div>

  







<!-- ğŸ“Œ í”¼ë“œ ëª©ë¡ -->
<section>
  <h3 id="feeds-title">ğŸ“Œ í”¼ë“œ ëª©ë¡</h3>
  <div id="feeds"></div>
</section>
<div id="scroll-anchor"></div> <!-- ğŸ”¥ ë¬´í•œìŠ¤í¬ë¡¤ ì•µì»¤ -->


<script src="js/main.js"></script>

<script>

function openNotificationCenter() {
  const dropdown = document.getElementById("notif-dropdown");
  const isOpen = dropdown.style.display === "block";
  dropdown.style.display = isOpen ? "none" : "block";

  if (!isOpen) {
    if (!localStorage.getItem("notifOpened")) {
      localStorage.setItem("notifOpened", "true");
      console.log("âœ… notifOpened ì €ì¥ë¨!");
    }
    loadNotifications();
  }
}

async function loadNotifications() {
  const res = await fetch("https://supermax.kr/feed/my-notifications", {
    method: "POST",
    headers: {
      Authorization: "Bearer " + localStorage.getItem("token"),
      "Content-Type": "application/json"
    },
    body: JSON.stringify({})
  });

  const notifs = await res.json();  // ğŸ”¥ ì´ ì¤„ ê¼­ ìˆì–´ì•¼ í•¨!!!

  const container = document.getElementById("notif-dropdown");

  if (notifs.length === 0) {
    container.innerHTML = "<div style='padding:10px; color:#888;'>ì•Œë¦¼ì´ ì—†ìŠµë‹ˆë‹¤</div>";
    return;
  }

  container.innerHTML = `
    <div style="padding: 8px 10px; font-size: 0.85rem; text-align: right; border-bottom: 1px solid #eee;">
      <span onclick="clearNotifications()" style="cursor: pointer; color: #888;">ğŸ—‘ ì•Œë¦¼ ì§€ìš°ê¸°</span>
    </div>
  ` + notifs.map(n => `
    <div onclick="goToFeed(${n.feed_id}, ${n.id})"
         style="padding: 10px; border-bottom: 1px solid #eee; cursor: pointer;">
      ${n.message}
    </div>
  `).join('');
}


async function clearNotifications() {
  await fetch("https://supermax.kr/feed/clear-notifications", {
    method: "POST",
    headers: {
      Authorization: "Bearer " + localStorage.getItem("token"),
      "Content-Type": "application/json"
    }
  });

  // ë°”ë¡œ UI ì´ˆê¸°í™”
  const container = document.getElementById("notif-dropdown");
  container.innerHTML = "<div style='padding:10px; color:#888;'>ì•Œë¦¼ì´ ì—†ìŠµë‹ˆë‹¤</div>";
  
  // ì¹´ìš´íŠ¸ ë±ƒì§€ë„ ìˆ¨ê¸°ê¸°
  document.getElementById("notif-count").style.display = "none";
}


async function goToFeed(feedId, notifId) {
  // ì½ìŒ ì²˜ë¦¬
  await fetch("https://supermax.kr/feed/read-notification", {
    method: "POST",
    headers: {
      Authorization: "Bearer " + localStorage.getItem("token"),
      "Content-Type": "application/json"
    },
    body: JSON.stringify({ id: notifId })
  });

  location.href = `feed-detail.html?feedId=${feedId}`;
}




async function checkNotifications() {
  try {
    const res = await fetch("https://supermax.kr/feed/my-notifications", {
      method: "POST",
      headers: {
        Authorization: "Bearer " + localStorage.getItem("token"),
        "Content-Type": "application/json"
      },
      body: JSON.stringify({})
    });
    const notifs = await res.json();

    const countEl = document.getElementById("notif-count");
    const prevCount = parseInt(localStorage.getItem("prevNotifCount") || "0");

    if (notifs.length > 0) {
      countEl.style.display = "inline-block";
      countEl.innerText = notifs.length;

      // âœ… ìƒˆë¡œ ìƒê¸´ ì•Œë¦¼ì´ ìˆë‹¤ë©´ í† ìŠ¤íŠ¸ ë„ìš°ê¸°
      if (notifs.length > prevCount) {
        showToast(`ğŸ”” ìƒˆë¡œìš´ ì•Œë¦¼ ${notifs.length}ê°œ ë„ì°©!`);
      }

      // âœ… í˜„ì¬ ê°œìˆ˜ë¥¼ ì €ì¥
      localStorage.setItem("prevNotifCount", notifs.length.toString());
    } else {
      countEl.style.display = "none";
      localStorage.setItem("prevNotifCount", "0");
    }
  } catch (e) {
    console.warn("âŒ ì•Œë¦¼ ì²´í¬ ì‹¤íŒ¨", e);
  }
}





setInterval(checkNotifications, 10000); // 10ì´ˆë§ˆë‹¤ ì²´í¬





  async function loadMyProfileImageForNav() {
  const userId = localStorage.getItem("user_id");
  if (!userId) return;

  const userData = await secureFetchUserInfo(userId);
  if (!userData) return;

  document.getElementById("nav-profile-img").src = userData.profile_image || "https://placehold.co/32x32";
}


document.addEventListener("DOMContentLoaded", async () => {
  checkNotifications(); 
  loadMyProfileImageForNav();

  const token = localStorage.getItem("token");

  // âœ… âœ… âœ… ì´ ë¶€ë¶„ ì¶”ê°€!
  if (!token) {
    // ë¹„íšŒì› ìƒíƒœ ì²˜ë¦¬
    document.getElementById("guest-actions").style.display = "block";

    // ì—…ë¡œë“œ ë²„íŠ¼ ë¹„í™œì„±í™”
    const uploadBtn = document.querySelector('.bottom-nav button[onclick*="upload.html"]');
    if (uploadBtn) {
      uploadBtn.onclick = () => {
        alert("ë¡œê·¸ì¸ í›„ ì´ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤ ğŸ˜Š");
        location.href = 'login.html';
      };
    }

    // ì•Œë¦¼ ë²¨ ë¹„í™œì„±í™”
    const notifIcon = document.getElementById("notif-icon-wrapper");
    if (notifIcon) {
      notifIcon.onclick = () => {
        alert("ë¡œê·¸ì¸ í›„ ì•Œë¦¼ í™•ì¸ ê°€ëŠ¥í•´ìš” ğŸ˜Š");
        location.href = 'login.html';
      };
    }

    // ê´€ë¦¬ì ë²„íŠ¼ ìˆ¨ê¹€
    document.getElementById("admin-button").style.display = "none";
    return; // âœ… ê´€ë¦¬ì ì²´í¬ ì•„ë˜ ì½”ë“œ ì‹¤í–‰ ì•ˆ í•˜ë„ë¡ ë¦¬í„´!
  }

  // ê´€ë¦¬ì ì²´í¬ëŠ” ë¡œê·¸ì¸í•œ ê²½ìš°ì—ë§Œ
  try {
    const payload = JSON.parse(atob(token.split('.')[1]));
    if (payload?.username === 'admin') {
      document.getElementById("admin-button").style.display = "inline-block";
    }
  } catch (e) {
    console.warn("âŒ ê´€ë¦¬ì í† í° í™•ì¸ ì‹¤íŒ¨:", e);
  }
});




  lucide.createIcons();


  
</script>

<!-- ğŸ“Œ index.html ë§ˆì§€ë§‰ì— ì¶”ê°€ (</body> ë°”ë¡œ ìœ„) -->
<div class="bottom-nav">
  <button onclick="resetFeedState('/feeds'); loadFeeds('/feeds')" title="í™ˆ">
    <!-- home.svg -->
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-house"><path d="M15 21v-8a1 1 0 0 0-1-1h-4a1 1 0 0 0-1 1v8"/><path d="M3 10a2 2 0 0 1 .709-1.528l7-5.999a2 2 0 0 1 2.582 0l7 5.999A2 2 0 0 1 21 10v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/></svg>
  </button>

  <button onclick="location.href='upload.html'" title="ì—…ë¡œë“œ">
    <!-- plus.svg -->
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-plus"><path d="M5 12h14"/><path d="M12 5v14"/></svg>
  </button>
  <button onclick="location.href='record-chart.html'" title="ê¸°ë¡ì°¨íŠ¸">
    <!-- video.svg -->
  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-chart-spline"><path d="M3 3v16a2 2 0 0 0 2 2h16"/><path d="M7 16c.5-2 1.5-7 4-7 2 0 2 3 4 3 2.5 0 4.5-5 5-7"/></svg>
</button>
  <button onclick="location.href='profile-feed.html'">
    <img id="nav-profile-img" src="https://placehold.co/32x32" alt="ë‚´ í”„ë¡œí•„" style="width: 32px; height: 32px; border-radius: 50%;" />
  </button>
  
</div>



</body>
</html>
